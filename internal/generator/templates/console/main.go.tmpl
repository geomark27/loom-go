package main

import (
	"log"

	"{{.ModuleName}}/{{.ConfigPath}}"
	"{{.ModuleName}}/internal/database"
	"{{.ModuleName}}/internal/database/seeders"

	"github.com/spf13/cobra"
	"gorm.io/gorm"
)

func main() {
	rootCmd := &cobra.Command{
		Use:   "console",
		Short: "Database console tools for {{.Name}}",
		Long:  `Command-line tools for managing database migrations and seeders`,
	}

	// migrate command
	migrateCmd := &cobra.Command{
		Use:   "migrate",
		Short: "Run database migrations",
		Long:  `Automatically migrate database schema based on your models`,
		Run:   runMigrate,
	}
	migrateCmd.Flags().Bool("seed", false, "Run seeders after migration")
	migrateCmd.Flags().Bool("fresh", false, "Drop all tables and migrate from scratch")

	// seed command
	seedCmd := &cobra.Command{
		Use:   "seed",
		Short: "Run database seeders",
		Long:  `Populate database with initial or test data`,
		Run:   runSeed,
	}

	rootCmd.AddCommand(migrateCmd, seedCmd)

	if err := rootCmd.Execute(); err != nil {
		log.Fatal(err)
	}
}

func runMigrate(cmd *cobra.Command, args []string) {
	// Load configuration
	cfg := config.LoadConfig()

	// Initialize database
	db, err := database.InitDB(cfg)
	if err != nil {
		log.Fatalf("‚ùå Error connecting to database: %v", err)
	}
	defer database.CloseDB()

	// Check for fresh flag
	fresh, _ := cmd.Flags().GetBool("fresh")
	if fresh {
		log.Println("üóëÔ∏è  Dropping all tables...")
		if err := db.Migrator().DropTable(database.AllModels...); err != nil {
			log.Printf("‚ö†Ô∏è  Warning dropping tables: %v", err)
		}
	}

	// Run migrations
	log.Println("üîÑ Running migrations...")
	if err := db.AutoMigrate(database.AllModels...); err != nil {
		log.Fatalf("‚ùå Migration error: %v", err)
	}
	log.Println("‚úÖ Migrations completed successfully")

	// Check for seed flag
	withSeed, _ := cmd.Flags().GetBool("seed")
	if withSeed {
		runSeedLogic(db)
	}
}

func runSeed(cmd *cobra.Command, args []string) {
	// Load configuration
	cfg := config.LoadConfig()

	// Initialize database
	db, err := database.InitDB(cfg)
	if err != nil {
		log.Fatalf("‚ùå Error connecting to database: %v", err)
	}
	defer database.CloseDB()

	runSeedLogic(db)
}

func runSeedLogic(db *gorm.DB) {
	seeder := &seeders.DatabaseSeeder{}
	if err := seeder.Run(db); err != nil {
		log.Fatalf("‚ùå Seeder error: %v", err)
	}
}
