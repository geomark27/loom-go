package handlers

import (
	"encoding/json"
	"net/http"
	"strconv"

	"{{.ModuleName}}/internal/app/dtos"
	"{{.ModuleName}}/internal/app/services"
{{- if .UseHelpers}}
	"github.com/geomark27/loom-go/pkg/helpers"
{{- end}}
	"github.com/gorilla/mux"
)

// UserHandler maneja las rutas relacionadas con usuarios
type UserHandler struct {
	userService *services.UserService
{{- if .UseHelpers}}
	logger      helpers.Logger
{{- end}}
}

// NewUserHandler crea una nueva instancia de UserHandler
func NewUserHandler(userService *services.UserService) *UserHandler {
	return &UserHandler{
		userService: userService,
{{- if .UseHelpers}}
		logger:      helpers.NewLogger(),
{{- end}}
	}
}

// GetUsers obtiene todos los usuarios
func (h *UserHandler) GetUsers(w http.ResponseWriter, r *http.Request) {
	users, err := h.userService.GetAllUsers()
	if err != nil {
{{- if .UseHelpers}}
		h.logger.Error("Failed to get users", "error", err)
		helpers.RespondError(w, err, http.StatusInternalServerError)
{{- else}}
		http.Error(w, "Error obteniendo usuarios", http.StatusInternalServerError)
{{- end}}
		return
	}
{{- if .UseHelpers}}

	helpers.RespondSuccess(w, map[string]interface{}{
		"users": users,
		"count": len(users),
	}, "Usuarios obtenidos exitosamente")
{{- else}}

	w.Header().Set("Content-Type", "application/json")
	json.NewEncoder(w).Encode(map[string]interface{}{
		"data":    users,
		"count":   len(users),
		"status":  "success",
		"message": "Usuarios obtenidos exitosamente",
	})
{{- end}}
}

// GetUser obtiene un usuario por ID
func (h *UserHandler) GetUser(w http.ResponseWriter, r *http.Request) {
	vars := mux.Vars(r)
	id, err := strconv.Atoi(vars["id"])
	if err != nil {
{{- if .UseHelpers}}
		helpers.RespondError(w, helpers.ErrBadRequest, http.StatusBadRequest)
{{- else}}
		http.Error(w, "ID de usuario inválido", http.StatusBadRequest)
{{- end}}
		return
	}

	user, err := h.userService.GetUserByID(id)
	if err != nil {
		if err.Error() == "user not found" {
{{- if .UseHelpers}}
			helpers.RespondError(w, helpers.ErrNotFound, http.StatusNotFound)
{{- else}}
			http.Error(w, "Usuario no encontrado", http.StatusNotFound)
{{- end}}
			return
		}
{{- if .UseHelpers}}
		helpers.RespondError(w, err, http.StatusInternalServerError)
{{- else}}
		http.Error(w, "Error obteniendo usuario", http.StatusInternalServerError)
{{- end}}
		return
	}
{{- if .UseHelpers}}

	helpers.RespondSuccess(w, user, "Usuario obtenido exitosamente")
{{- else}}

	w.Header().Set("Content-Type", "application/json")
	json.NewEncoder(w).Encode(map[string]interface{}{
		"data":    user,
		"status":  "success",
		"message": "Usuario obtenido exitosamente",
	})
{{- end}}
}

// CreateUser crea un nuevo usuario
func (h *UserHandler) CreateUser(w http.ResponseWriter, r *http.Request) {
	var createUserDTO dtos.CreateUserDTO
	if err := json.NewDecoder(r.Body).Decode(&createUserDTO); err != nil {
{{- if .UseHelpers}}
		helpers.RespondError(w, helpers.ErrBadRequest, http.StatusBadRequest)
{{- else}}
		http.Error(w, "Datos de entrada inválidos", http.StatusBadRequest)
{{- end}}
		return
	}
{{- if .UseHelpers}}

	// Validar DTO usando helpers
	if errors := helpers.ValidateStruct(createUserDTO); len(errors) > 0 {
		helpers.RespondJSON(w, map[string]interface{}{
			"status": "error",
			"errors": errors,
		}, http.StatusBadRequest)
		return
	}
{{- else}}

	// Validar DTO
	if err := createUserDTO.Validate(); err != nil {
		http.Error(w, err.Error(), http.StatusBadRequest)
		return
	}
{{- end}}

	user, err := h.userService.CreateUser(createUserDTO)
	if err != nil {
{{- if .UseHelpers}}
		h.logger.Error("Failed to create user", "error", err)
		helpers.RespondError(w, err, http.StatusInternalServerError)
{{- else}}
		http.Error(w, "Error creando usuario", http.StatusInternalServerError)
{{- end}}
		return
	}
{{- if .UseHelpers}}

	helpers.RespondCreated(w, user, "Usuario creado exitosamente")
{{- else}}

	w.Header().Set("Content-Type", "application/json")
	w.WriteHeader(http.StatusCreated)
	json.NewEncoder(w).Encode(map[string]interface{}{
		"data":    user,
		"status":  "success",
		"message": "Usuario creado exitosamente",
	})
{{- end}}
}

// UpdateUser actualiza un usuario existente
func (h *UserHandler) UpdateUser(w http.ResponseWriter, r *http.Request) {
	vars := mux.Vars(r)
	id, err := strconv.Atoi(vars["id"])
	if err != nil {
{{- if .UseHelpers}}
		helpers.RespondError(w, helpers.ErrBadRequest, http.StatusBadRequest)
{{- else}}
		http.Error(w, "ID de usuario inválido", http.StatusBadRequest)
{{- end}}
		return
	}

	var updateUserDTO dtos.UpdateUserDTO
	if err := json.NewDecoder(r.Body).Decode(&updateUserDTO); err != nil {
{{- if .UseHelpers}}
		helpers.RespondError(w, helpers.ErrBadRequest, http.StatusBadRequest)
{{- else}}
		http.Error(w, "Datos de entrada inválidos", http.StatusBadRequest)
{{- end}}
		return
	}

	user, err := h.userService.UpdateUser(id, updateUserDTO)
	if err != nil {
		if err.Error() == "user not found" {
{{- if .UseHelpers}}
			helpers.RespondError(w, helpers.ErrNotFound, http.StatusNotFound)
{{- else}}
			http.Error(w, "Usuario no encontrado", http.StatusNotFound)
{{- end}}
			return
		}
{{- if .UseHelpers}}
		helpers.RespondError(w, err, http.StatusInternalServerError)
{{- else}}
		http.Error(w, "Error actualizando usuario", http.StatusInternalServerError)
{{- end}}
		return
	}
{{- if .UseHelpers}}

	helpers.RespondSuccess(w, user, "Usuario actualizado exitosamente")
{{- else}}

	w.Header().Set("Content-Type", "application/json")
	json.NewEncoder(w).Encode(map[string]interface{}{
		"data":    user,
		"status":  "success",
		"message": "Usuario actualizado exitosamente",
	})
{{- end}}
}

// DeleteUser elimina un usuario
func (h *UserHandler) DeleteUser(w http.ResponseWriter, r *http.Request) {
	vars := mux.Vars(r)
	id, err := strconv.Atoi(vars["id"])
	if err != nil {
{{- if .UseHelpers}}
		helpers.RespondError(w, helpers.ErrBadRequest, http.StatusBadRequest)
{{- else}}
		http.Error(w, "ID de usuario inválido", http.StatusBadRequest)
{{- end}}
		return
	}

	if err := h.userService.DeleteUser(id); err != nil {
		if err.Error() == "user not found" {
{{- if .UseHelpers}}
			helpers.RespondError(w, helpers.ErrNotFound, http.StatusNotFound)
{{- else}}
			http.Error(w, "Usuario no encontrado", http.StatusNotFound)
{{- end}}
			return
		}
{{- if .UseHelpers}}
		helpers.RespondError(w, err, http.StatusInternalServerError)
{{- else}}
		http.Error(w, "Error eliminando usuario", http.StatusInternalServerError)
{{- end}}
		return
	}
{{- if .UseHelpers}}

	helpers.RespondSuccess(w, nil, "Usuario eliminado exitosamente")
{{- else}}

	w.Header().Set("Content-Type", "application/json")
	json.NewEncoder(w).Encode(map[string]interface{}{
		"status":  "success",
		"message": "Usuario eliminado exitosamente",
	})
{{- end}}
}
